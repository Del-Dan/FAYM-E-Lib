{% extends 'library/base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto text-center mb-12" x-data="{ query: '', category: '', filterType: 'all' }">
    <h1 class="text-5xl font-extrabold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
        Find Your Next Read
    </h1>
    <p class="text-slate-500 text-lg mb-8">Search our collection of Hard Copy and Soft Copy books.</p>

    <div class="relative max-w-3xl mx-auto mb-8 flex gap-2">
        <select name="filter_type" x-model="filterType"
            class="px-4 py-4 rounded-l-full border-2 border-r-0 border-slate-200 bg-slate-50 focus:border-blue-500 focus:outline-none text-slate-700 font-medium"
            hx-get="{% url 'search_books' %}" hx-trigger="change" hx-target="#book-results"
            hx-include="[name='q'], [name='category']">
            <option value="all">Check All</option>
            <option value="title">Title</option>
            <option value="author">Author</option>
            <option value="keywords">Keywords</option>
        </select>

        <div class="relative flex-1">
            <input type="text" name="q" x-model="query" list="search-suggestions"
                class="w-full px-6 py-4 rounded-r-full border-2 border-slate-200 focus:border-blue-500 focus:outline-none shadow-sm text-lg transition-colors"
                placeholder="Search..." hx-get="{% url 'search_books' %}" hx-trigger="keyup changed delay:300ms, search"
                hx-target="#book-results" hx-include="[name='category'], [name='filter_type']"
                @keyup.debounce.300ms="htmx.ajax('GET', '{% url 'suggest_books' %}', {target:'#search-suggestions', values:{q:query}})">

            <datalist id="search-suggestions"></datalist>

            <button
                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-600 transition-colors p-2"
                @click="htmx.trigger(document.querySelector('[name=q]'), 'search')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Category Pills -->
    <div class="flex flex-wrap justify-center gap-2 mb-12">
        <input type="hidden" name="category" x-model="category">
        {% for cat in categories %}
        <button
            @click="category = category === '{{ cat }}' ? '' : '{{ cat }}'; $nextTick(() => htmx.trigger($el, 'change'))"
            :class="category === '{{ cat }}' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 hover:bg-slate-50'"
            class="px-4 py-2 rounded-full border border-slate-200 text-sm font-medium transition-colors cursor-pointer select-none shadow-sm"
            hx-get="{% url 'search_books' %}" hx-trigger="change" hx-target="#book-results"
            hx-vals='js:{q: document.querySelector("[name=q]").value, category: category === "{{ cat }}" ? "{{ cat }}" : ""}'>
            {{ cat }}
        </button>
        {% endfor %}
    </div>

    <!-- Results Area -->
    <div id="book-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
        {% include 'library/partials/book_list.html' %}
    </div>
</div>

<!-- Request Modal (Global) - Utilizing Alpine for state -->
<!-- Request Modal (Global) - Multi-step OTP Flow -->
<div x-data="requestModal"
    @open-request-modal.window="open = true; bookId = $event.detail.id; bookTitle = $event.detail.title; reset();"
    x-show="open" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;" x-transition.opacity>

    <!-- Toast UI -->
    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        class="fixed top-6 right-6 z-[100] px-6 py-4 rounded-xl shadow-2xl text-white font-semibold flex items-center gap-3 min-w-[300px]"
        :class="toast.type === 'error' ? 'bg-rose-600' : 'bg-emerald-600'">
        <span
            x-html="toast.type === 'error' ? 
            '<svg class=\'w-6 h-6\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\'/></svg>' : 
            '<svg class=\'w-6 h-6\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M5 13l4 4L19 7\'/></svg>'">
        </span>
        <span x-text="toast.msg"></span>
    </div>

    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="open = false"></div>

    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>

            <h2 class="text-2xl font-bold mb-2">Request Book</h2>
            <p class="text-slate-500 mb-6">Requesting: <span class="font-semibold text-slate-800"
                    x-text="bookTitle"></span></p>

            <form action="{% url 'submit_request' %}" method="POST" class="space-y-4" @submit="isLoading = true">
                {% csrf_token %}
                <input type="hidden" name="book_id" x-model="bookId">

                <!-- Step 1: Identity -->
                <div x-show="step === 1" x-transition>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email or Mobile Number</label>
                    <input type="text" name="identity" x-model="identity" @keyup.debounce.500ms="checkMember()"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="e.g. 055..." required>

                    <p x-show="identity.length > 3" class="text-xs mt-1"
                        :class="isValidMember ? 'text-green-600' : 'text-red-500'"
                        x-text="isValidMember ? 'Member Verified' : 'Checking...'">
                    </p>

                    <button type="button" x-show="isValidMember" @click="sendOtp()" :disabled="isLoading"
                        class="w-full mt-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors">
                        <span x-show="!isLoading">Verify Identity</span>
                        <span x-show="isLoading">Sending OTP...</span>
                    </button>

                    <div x-show="!isValidMember && identity.length > 8 && !isLoading" class="mt-2 text-sm text-red-500">
                        Member not found. Check digits.
                    </div>
                </div>

                <!-- Step 2: OTP Entry -->
                <div x-show="step === 2" x-transition style="display: none;">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Enter OTP Code</label>
                    <input type="text" x-model="otpCode"
                        class="w-full px-4 py-2 text-center text-2xl tracking-widest rounded-lg border border-slate-300 focus:ring-blue-500 outline-none"
                        placeholder="000000" maxlength="6">

                    <div class="flex gap-2 mt-4">
                        <button type="button" @click="step = 1"
                            class="flex-1 py-2 border border-slate-300 rounded-lg text-slate-600">Back</button>
                        <button type="button" @click="verifyOtp()" :disabled="isLoading || otpCode.length < 4"
                            class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-show="!isLoading">Verify Code</span>
                            <span x-show="isLoading">Verifying...</span>
                        </button>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-2">Check your SMS.</p>
                </div>

                <!-- Step 3: Final Submit -->
                <div x-show="step === 3" x-transition style="display: none;">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-green-100 rounded-full mb-2">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-green-800">Identity Verified</h3>
                        <p class="text-sm text-slate-500">Session valid for 30 minutes.</p>
                    </div>

                    <button type="submit" :disabled="isLoading"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg disabled:opacity-50">
                        <span x-show="!isLoading">Confirm Request</span>
                        <span x-show="isLoading">Processing...</span>
                    </button>
                </div>
            </form>

            <button @click="open = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('requestModal', () => ({
            open: false,
            step: 1,
            bookId: '',
            bookTitle: '',
            identity: '',
            otpCode: '',
            isValidMember: false,
            isLoading: false,
            csrf: document.querySelector('[name=csrfmiddlewaretoken]').value,

            toast: { show: false, msg: '', type: 'success' },

            showToast(message, type = 'success') {
                this.toast.msg = message;
                this.toast.type = type;
                this.toast.show = true;
                setTimeout(() => { this.toast.show = false }, 4000);
            },

            reset() {
                this.step = 1;
                this.identity = '';
                this.otpCode = '';
                this.isValidMember = false;
                this.isLoading = false;
            },

            async checkMember() {
                if (this.identity.length < 3) return;
                try {
                    let res = await fetch(`{% url 'check_member' %}?identity=${this.identity}`);
                    if (!res.ok) throw new Error('Server Error');
                    let data = await res.json();
                    this.isValidMember = data.valid;
                } catch (e) {
                    console.error(e);
                    // Silent fail or toast
                    this.showToast("Connection Error", 'error');
                }
            },

            async sendOtp() {
                this.isLoading = true;
                let fd = new FormData();
                fd.append('identity', this.identity);
                fd.append('csrfmiddlewaretoken', this.csrf);

                try {
                    let res = await fetch(`{% url 'send_otp' %}`, { method: 'POST', body: fd });
                    if (!res.ok) throw new Error('Server Error');

                    let data = await res.json();
                    if (data.status === 'sent') {
                        this.showToast(data.message, 'success');
                        this.step = 2;
                    } else {
                        this.showToast(data.message, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    this.showToast("Failed to connect to server.", 'error');
                } finally {
                    this.isLoading = false;
                }
            },

            async verifyOtp() {
                this.isLoading = true;
                let fd = new FormData();
                fd.append('otp_code', this.otpCode);
                fd.append('csrfmiddlewaretoken', this.csrf);

                try {
                    let res = await fetch(`{% url 'verify_otp' %}`, { method: 'POST', body: fd });
                    if (!res.ok) throw new Error('Server Error');

                    let data = await res.json();
                    if (data.status === 'success') {
                        this.showToast(data.message, 'success');
                        this.step = 3;
                    } else {
                        this.showToast(data.message, 'error');
                    }
                } catch (e) {
                    console.error(e);
                    this.showToast("Failed to verify code.", 'error');
                } finally {
                    this.isLoading = false;
                }
            }
        }));
    });
</script>
{% endblock %}