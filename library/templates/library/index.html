{% extends 'library/base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto text-center mb-12" x-data="{ query: '', category: '' }">
    <h1 class="text-5xl font-extrabold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
        Find Your Next Read
    </h1>
    <p class="text-slate-500 text-lg mb-8">Search our collection of Hard Copy and Soft Copy books.</p>

    <!-- Search Bar -->
    <div class="relative max-w-2xl mx-auto mb-8">
        <input type="text" name="q" x-model="query"
            class="w-full px-6 py-4 rounded-full border-2 border-slate-200 focus:border-blue-500 focus:outline-none shadow-sm text-lg transition-colors"
            placeholder="Search by title, author, or keyword..." hx-get="{% url 'search_books' %}"
            hx-trigger="keyup changed delay:300ms, search" hx-target="#book-results" hx-include="[name='category']">
        <div class="absolute right-4 top-4 text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
    </div>

    <!-- Category Pills -->
    <div class="flex flex-wrap justify-center gap-2 mb-12">
        <input type="hidden" name="category" x-model="category">
        {% for cat in categories %}
        <button
            @click="category = category === '{{ cat }}' ? '' : '{{ cat }}'; $nextTick(() => htmx.trigger($el, 'change'))"
            :class="category === '{{ cat }}' ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 hover:bg-slate-50'"
            class="px-4 py-2 rounded-full border border-slate-200 text-sm font-medium transition-colors cursor-pointer select-none shadow-sm"
            hx-get="{% url 'search_books' %}" hx-trigger="change" hx-target="#book-results"
            hx-vals='js:{q: document.querySelector("[name=q]").value, category: category === "{{ cat }}" ? "{{ cat }}" : ""}'>
            {{ cat }}
        </button>
        {% endfor %}
    </div>

    <!-- Results Area -->
    <div id="book-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
        {% include 'library/partials/book_list.html' %}
    </div>
</div>

<!-- Request Modal (Global) - Utilizing Alpine for state -->
<div x-data="{ open: false, bookId: '', bookTitle: '', identity: '', isValid: false }"
    @open-request-modal.window="open = true; bookId = $event.detail.id; bookTitle = $event.detail.title; isValid = false; identity = '';"
    x-show="open" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;" x-transition.opacity>

    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="open = false"></div>

    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>

            <h2 class="text-2xl font-bold mb-2">Request Book</h2>
            <p class="text-slate-500 mb-6">Requesting: <span class="font-semibold text-slate-800"
                    x-text="bookTitle"></span></p>

            <form action="{% url 'submit_request' %}" method="POST" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="book_id" x-model="bookId">

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email or Mobile Number</label>
                    <input type="text" name="identity" x-model="identity"
                        @keyup.debounce.500ms="fetch(`{% url 'check_member' %}?identity=${identity}`).then(r => r.json()).then(d => isValid = d.valid)"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                        placeholder="e.g. john@example.com" required>
                    <p x-show="identity.length > 3" class="text-xs mt-1"
                        :class="isValid ? 'text-green-600' : 'text-red-500'"
                        x-text="isValid ? 'Member Verified' : 'Checking... (Must be a registered member)'"></p>
                </div>

                <div x-show="isValid" x-transition>
                    <button type="submit"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg shadow-blue-500/30 transition-all transform hover:-translate-y-0.5">
                        Submit Request
                    </button>
                </div>

                <div x-show="!isValid && identity.length > 5" x-transition
                    class="text-center p-4 bg-orange-50 rounded-lg border border-orange-100">
                    <p class="text-sm text-orange-800">We couldn't verify your membership.</p>
                </div>
            </form>

            <button @click="open = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}